import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, increment } from 'firebase/firestore';

// --- BIáº¾N MÃ”I TRÆ¯á»œNG (DO CANVAS CUNG Cáº¤P) ---
const firebaseConfig = typeof __firebase_config !== 'undefined'
  ? JSON.parse(__firebase_config)
  : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };

const appId = typeof __app_id !== 'undefined' ? __app_id : 'nihongo-go-demo';

// --- KHá»žI Táº O FIREBASE ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- NGÃ‚N HÃ€NG Dá»® LIá»†U N5 (ÄÃƒ Má»ž Rá»˜NG TOÃ€N DIá»†N) ---
const N5Database = {
    srsItems: [
        // === Kanji (Má»Ÿ rá»™ng) ===
        { id: 'kanji_1', type: 'Kanji', content: 'æ—¥', meaning: 'Nháº­t (NgÃ y)', reading: 'On: ã«ã¡, ã˜ã¤ / Kun: ã², -ã‹', examples: [{ word: 'æ—¥æœ¬', reading: 'ã«ã»ã‚“', meaning: 'Nháº­t Báº£n' }, { word: 'ä»Šæ—¥', reading: 'ãã‚‡ã†', meaning: 'HÃ´m nay' }] },
        { id: 'kanji_2', type: 'Kanji', content: 'ä¸€', meaning: 'Nháº¥t (Má»™t)', reading: 'On: ã„ã¡ / Kun: ã²ã¨', examples: [{ word: 'ä¸€ç•ª', reading: 'ã„ã¡ã°ã‚“', meaning: 'Sá»‘ má»™t' }, { word: 'ä¸€ã¤', reading: 'ã²ã¨ã¤', meaning: 'Má»™t cÃ¡i' }] },
        { id: 'kanji_3', type: 'Kanji', content: 'å›½', meaning: 'Quá»‘c (Äáº¥t nÆ°á»›c)', reading: 'On: ã“ã / Kun: ãã«', examples: [{ word: 'å›½', reading: 'ãã«', meaning: 'Äáº¥t nÆ°á»›c' }, { word: 'ä¸­å›½äºº', reading: 'ã¡ã‚…ã†ã”ãã˜ã‚“', meaning: 'NgÆ°á»i Trung Quá»‘c' }] },
        { id: 'kanji_4', type: 'Kanji', content: 'äºº', meaning: 'NhÃ¢n (NgÆ°á»i)', reading: 'On: ã˜ã‚“, ã«ã‚“ / Kun: ã²ã¨', examples: [{ word: 'æ—¥æœ¬äºº', reading: 'ã«ã»ã‚“ã˜ã‚“', meaning: 'NgÆ°á»i Nháº­t' }, { word: 'ä¸‰äºº', reading: 'ã•ã‚“ã«ã‚“', meaning: 'Ba ngÆ°á»i' }] },
        { id: 'kanji_5', type: 'Kanji', content: 'å¹´', meaning: 'NiÃªn (NÄƒm)', reading: 'On: ã­ã‚“', examples: [{ word: 'ä»Šå¹´', reading: 'ã“ã¨ã—', meaning: 'NÄƒm nay' }, { word: 'æ¥å¹´', reading: 'ã‚‰ã„ã­ã‚“', meaning: 'NÄƒm sau' }] },
        { id: 'kanji_6', type: 'Kanji', content: 'å¤§', meaning: 'Äáº¡i (Lá»›n)', reading: 'On: ã ã„, ãŸã„ / Kun: ãŠãŠ', examples: [{ word: 'å¤§å­¦', reading: 'ã ã„ãŒã', meaning: 'Äáº¡i há»c' }, { word: 'å¤§ãã„', reading: 'ãŠãŠãã„', meaning: 'To, lá»›n' }] },
        { id: 'kanji_7', type: 'Kanji', content: 'å', meaning: 'Tháº­p (MÆ°á»i)', reading: 'On: ã˜ã‚…ã† / Kun: ã¨ãŠ', examples: [{ word: 'å', reading: 'ã˜ã‚…ã†', meaning: 'MÆ°á»i' }, { word: 'åæ—¥', reading: 'ã¨ãŠã‹', meaning: 'NgÃ y 10' }] },
        { id: 'kanji_8', type: 'Kanji', content: 'äºŒ', meaning: 'Nhá»‹ (Hai)', reading: 'On: ã« / Kun: ãµãŸ', examples: [{ word: 'äºŒã¤', reading: 'ãµãŸã¤', meaning: 'Hai cÃ¡i' }, { word: 'äºŒæœˆ', reading: 'ã«ãŒã¤', meaning: 'ThÃ¡ng 2' }] },
        { id: 'kanji_9', type: 'Kanji', content: 'æœ¬', meaning: 'Báº£n (SÃ¡ch)', reading: 'On: ã»ã‚“ / Kun: ã‚‚ã¨', examples: [{ word: 'æœ¬', reading: 'ã»ã‚“', meaning: 'SÃ¡ch' }, { word: 'å±±æœ¬', reading: 'ã‚„ã¾ã‚‚ã¨', meaning: 'Yamamoto (tÃªn ngÆ°á»i)' }] },
        { id: 'kanji_10', type: 'Kanji', content: 'ä¸­', meaning: 'Trung (Trong)', reading: 'On: ã¡ã‚…ã† / Kun: ãªã‹', examples: [{ word: 'ä¸­å›½', reading: 'ã¡ã‚…ã†ã”ã', meaning: 'Trung Quá»‘c' }, { word: 'ç”°ä¸­', reading: 'ãŸãªã‹', meaning: 'Tanaka (tÃªn ngÆ°á»i)' }] },
        { id: 'kanji_11', type: 'Kanji', content: 'é•·', meaning: 'TrÆ°á»ng (DÃ i)', reading: 'On: ã¡ã‚‡ã† / Kun: ãªãŒ.ã„', examples: [{ word: 'ç¤¾é•·', reading: 'ã—ã‚ƒã¡ã‚‡ã†', meaning: 'GiÃ¡m Ä‘á»‘c' }, { word: 'é•·ã„', reading: 'ãªãŒã„', meaning: 'DÃ i' }] },
        { id: 'kanji_12', type: 'Kanji', content: 'å‡º', meaning: 'Xuáº¥t (Ra)', reading: 'On: ã—ã‚…ã¤ / Kun: ã§.ã‚‹, ã .ã™', examples: [{ word: 'å‡ºã‚‹', reading: 'ã§ã‚‹', meaning: 'Äi ra' }, { word: 'å‡ºå£', reading: 'ã§ãã¡', meaning: 'Lá»‘i ra' }] },
        { id: 'kanji_13', type: 'Kanji', content: 'ä¸‰', meaning: 'Tam (Ba)', reading: 'On: ã•ã‚“ / Kun: ã¿ã£.ã¤', examples: [{ word: 'ä¸‰ã¤', reading: 'ã¿ã£ã¤', meaning: 'Ba cÃ¡i' }, { word: 'ä¸‰æœˆ', reading: 'ã•ã‚“ãŒã¤', meaning: 'ThÃ¡ng 3' }] },
        { id: 'kanji_14', type: 'Kanji', content: 'æ™‚', meaning: 'Thá»i (Giá»)', reading: 'On: ã˜ / Kun: ã¨ã', examples: [{ word: 'æ™‚é–“', reading: 'ã˜ã‹ã‚“', meaning: 'Thá»i gian' }, { word: 'æ™‚ã€…', reading: 'ã¨ãã©ã', meaning: 'Thá»‰nh thoáº£ng' }] },
        { id: 'kanji_15', type: 'Kanji', content: 'è¡Œ', meaning: 'HÃ nh (Äi)', reading: 'On: ã“ã†, ãŽã‚‡ã† / Kun: ã„.ã', examples: [{ word: 'è¡Œã', reading: 'ã„ã', meaning: 'Äi' }, { word: 'éŠ€è¡Œ', reading: 'ãŽã‚“ã“ã†', meaning: 'NgÃ¢n hÃ ng' }] },
        
        // === Tá»« vá»±ng (Má»Ÿ rá»™ng) ===
        { id: 'vocab_1', type: 'Tá»« vá»±ng', content: 'ç§', reading: 'ã‚ãŸã—', meaning: 'TÃ´i', example: 'ç§ã¯å­¦ç”Ÿã§ã™ã€‚' },
        { id: 'vocab_2', type: 'Tá»« vá»±ng', content: 'å­¦ç”Ÿ', reading: 'ãŒãã›ã„', meaning: 'Há»c sinh, sinh viÃªn', example: 'å½¼ã¯å­¦ç”Ÿã§ã™ã€‚' },
        { id: 'vocab_3', type: 'Tá»« vá»±ng', content: 'ã§ã™', reading: 'ã§ã™', meaning: 'LÃ  (kháº³ng Ä‘á»‹nh)', example: 'ã“ã‚Œã¯æœ¬ã§ã™ã€‚' },
        { id: 'vocab_4', type: 'Tá»« vá»±ng', content: 'ã¯ã„', reading: 'ã¯ã„', meaning: 'VÃ¢ng, dáº¡', example: 'ã¯ã„ã€ãã†ã§ã™ã€‚' },
        { id: 'vocab_5', type: 'Tá»« vá»±ng', content: 'ã„ã„ãˆ', reading: 'ã„ã„ãˆ', meaning: 'KhÃ´ng', example: 'ã„ã„ãˆã€é•ã„ã¾ã™ã€‚' },
        { id: 'vocab_6', type: 'Tá»« vá»±ng', content: 'ã“ã‚Œ', reading: 'ã“ã‚Œ', meaning: 'CÃ¡i nÃ y', example: 'ã“ã‚Œã¯ä½•ã§ã™ã‹ã€‚' },
        { id: 'vocab_7', type: 'Tá»« vá»±ng', content: 'ãã‚Œ', reading: 'ãã‚Œ', meaning: 'CÃ¡i Ä‘Ã³', example: 'ãã‚Œã¯ç§ã®å‚˜ã§ã™ã€‚' },
        { id: 'vocab_8', type: 'Tá»« vá»±ng', content: 'ã‚ã‚Œ', reading: 'ã‚ã‚Œ', meaning: 'CÃ¡i kia', example: 'ã‚ã‚Œã¯éŠ€è¡Œã§ã™ã€‚' },
        { id: 'vocab_9', type: 'Tá»« vá»±ng', content: 'æœ¬', reading: 'ã»ã‚“', meaning: 'SÃ¡ch', example: 'ã“ã‚Œã¯æ—¥æœ¬èªžã®æœ¬ã§ã™ã€‚' },
        { id: 'vocab_10', type: 'Tá»« vá»±ng', content: 'ä½•', reading: 'ãªã‚“ / ãªã«', meaning: 'CÃ¡i gÃ¬', example: 'ãã‚Œã¯ä½•ã§ã™ã‹ã€‚' },
        { id: 'vocab_11', type: 'Tá»« vá»±ng', content: 'è¡Œã', reading: 'ã„ã', meaning: 'Äi', example: 'å­¦æ ¡ã¸è¡Œãã¾ã™ã€‚' },
        { id: 'vocab_12', type: 'Tá»« vá»±ng', content: 'è¦‹ã‚‹', reading: 'ã¿ã‚‹', meaning: 'NhÃ¬n, xem', example: 'ãƒ†ãƒ¬ãƒ“ã‚’è¦‹ã¾ã™ã€‚' },
        { id: 'vocab_13', type: 'Tá»« vá»±ng', content: 'é£Ÿã¹ã‚‹', reading: 'ãŸã¹ã‚‹', meaning: 'Ä‚n', example: 'ã”é£¯ã‚’é£Ÿã¹ã¾ã™ã€‚' },
        { id: 'vocab_14', type: 'Tá»« vá»±ng', content: 'é£²ã‚€', reading: 'ã®ã‚€', meaning: 'Uá»‘ng', example: 'æ°´ã‚’é£²ã¿ã¾ã™ã€‚' },
        { id: 'vocab_15', type: 'Tá»« vá»±ng', content: 'å¤§ãã„', reading: 'ãŠãŠãã„', meaning: 'To, lá»›n', example: 'ã“ã®ã‹ã°ã‚“ã¯å¤§ãã„ã§ã™ã€‚' },
        { id: 'vocab_16', type: 'Tá»« vá»±ng', content: 'å°ã•ã„', reading: 'ã¡ã„ã•ã„', meaning: 'Nhá», bÃ©', example: 'ã‚ã®çŠ¬ã¯å°ã•ã„ã§ã™ã€‚' },
        { id: 'vocab_17', type: 'Tá»« vá»±ng', content: 'é«˜ã„', reading: 'ãŸã‹ã„', meaning: 'Cao, Ä‘áº¯t', example: 'å¯Œå£«å±±ã¯é«˜ã„ã§ã™ã€‚' },
        { id: 'vocab_18', type: 'Tá»« vá»±ng', content: 'å®‰ã„', reading: 'ã‚„ã™ã„', meaning: 'Ráº»', example: 'ã“ã®ã‚·ãƒ£ãƒ„ã¯å®‰ã„ã§ã™ã€‚' },
        { id: 'vocab_19', type: 'Tá»« vá»±ng', content: 'æ–°ã—ã„', reading: 'ã‚ãŸã‚‰ã—ã„', meaning: 'Má»›i', example: 'æ–°ã—ã„è»Šã‚’è²·ã„ã¾ã—ãŸã€‚' },
        { id: 'vocab_20', type: 'Tá»« vá»±ng', content: 'å¤ã„', reading: 'ãµã‚‹ã„', meaning: 'CÅ©', example: 'å¤ã„ãŠå¯ºã‚’è¦‹ã¾ã—ãŸã€‚' },
        
        // === Ngá»¯ phÃ¡p (Má»Ÿ rá»™ng) ===
        { id: 'grammar_1', type: 'Ngá»¯ phÃ¡p', content: 'N1 ã¯ N2 ã§ã™', meaning: 'N1 lÃ  N2', explanation: 'Máº«u cÃ¢u kháº³ng Ä‘á»‹nh cÆ¡ báº£n, dÃ¹ng Ä‘á»ƒ giá»›i thiá»‡u hoáº·c mÃ´ táº£.', example: 'ç§ ã¯ å­¦ç”Ÿ ã§ã™ã€‚(TÃ´i lÃ  há»c sinh.)' },
        { id: 'grammar_2', type: 'Ngá»¯ phÃ¡p', content: 'N1 ã¯ N2 ã˜ã‚ƒã‚ã‚Šã¾ã›ã‚“', meaning: 'N1 khÃ´ng pháº£i lÃ  N2', explanation: 'Máº«u cÃ¢u phá»§ Ä‘á»‹nh cá»§a ã€Œã§ã™ã€.', example: 'å±±ç”°ã•ã‚“ã¯å­¦ç”Ÿã˜ã‚ƒã‚ã‚Šã¾ã›ã‚“ã€‚(Anh Yamada khÃ´ng pháº£i lÃ  há»c sinh.)' },
        { id: 'grammar_3', type: 'Ngá»¯ phÃ¡p', content: 'S ã‹', meaning: 'CÃ¢u há»i', explanation: 'ThÃªm ã€Œã‹ã€ vÃ o cuá»‘i cÃ¢u Ä‘á»ƒ táº¡o cÃ¢u há»i. Giá»¯ nguyÃªn tráº­t tá»± cÃ¢u.', example: 'ãƒŸãƒ©ãƒ¼ã•ã‚“ã¯ã‚¢ãƒ¡ãƒªã‚«äººã§ã™ã‹ã€‚(Anh Miller lÃ  ngÆ°á»i Má»¹ pháº£i khÃ´ng?)' },
        { id: 'grammar_4', type: 'Ngá»¯ phÃ¡p', content: 'N ã‚‚', meaning: 'N cÅ©ng', explanation: 'DÃ¹ng Ä‘á»ƒ chá»‰ sá»± tÆ°Æ¡ng Ä‘á»“ng, thay tháº¿ cho trá»£ tá»« ã¯ hoáº·c ãŒ.', example: 'ç”°ä¸­ã•ã‚“ã¯æ—¥æœ¬äººã§ã™ã€‚ç§ã‚‚æ—¥æœ¬äººã§ã™ã€‚(Anh Tanaka lÃ  ngÆ°á»i Nháº­t. TÃ´i cÅ©ng lÃ  ngÆ°á»i Nháº­t.)' },
        { id: 'grammar_5', type: 'Ngá»¯ phÃ¡p', content: 'N1 ã® N2', meaning: 'N2 cá»§a N1', explanation: 'Chá»‰ sá»± sá»Ÿ há»¯u hoáº·c má»‘i quan há»‡ giá»¯a hai danh tá»«.', example: 'ã“ã‚Œã¯ç§ã®æœ¬ã§ã™ã€‚(ÄÃ¢y lÃ  sÃ¡ch cá»§a tÃ´i.)' },
        { id: 'grammar_6', type: 'Ngá»¯ phÃ¡p', content: 'N ã¯å ´æ‰€ã«ã‚ã‚Šã¾ã™/ã„ã¾ã™', meaning: 'N cÃ³ á»Ÿ (Ä‘á»‹a Ä‘iá»ƒm)', explanation: 'ã€Œã‚ã‚Šã¾ã™ã€dÃ¹ng cho Ä‘á»“ váº­t, ã€Œã„ã¾ã™ã€dÃ¹ng cho ngÆ°á»i vÃ  Ä‘á»™ng váº­t.', example: 'æœºã®ä¸Šã«æœ¬ãŒã‚ã‚Šã¾ã™ã€‚(TrÃªn bÃ n cÃ³ quyá»ƒn sÃ¡ch.)' },
        { id: 'grammar_7', type: 'Ngá»¯ phÃ¡p', content: 'V-ã¾ã™å½¢', meaning: 'Thá»ƒ V-masu', explanation: 'Dáº¡ng lá»‹ch sá»± cá»§a Ä‘á»™ng tá»«, dÃ¹ng trong cÃ¡c tÃ¬nh huá»‘ng trang trá»ng.', example: 'æ¯Žæ—¥ã€æ–°èžã‚’èª­ã¿ã¾ã™ã€‚(HÃ ng ngÃ y tÃ´i Ä‘á»c bÃ¡o.)' },
        { id: 'grammar_8', type: 'Ngá»¯ phÃ¡p', content: 'N ã‚’ Vã¾ã™', meaning: 'LÃ m V vá»›i N', explanation: 'Trá»£ tá»« ã‚’ chá»‰ Ä‘á»‘i tÆ°á»£ng trá»±c tiáº¿p cá»§a hÃ nh Ä‘á»™ng.', example: 'ãƒ‘ãƒ³ã‚’é£Ÿã¹ã¾ã™ã€‚(TÃ´i Äƒn bÃ¡nh mÃ¬.)' },
        { id: 'grammar_9', type: 'Ngá»¯ phÃ¡p', content: 'N ã«/ã¸è¡Œãã¾ã™', meaning: 'Äi Ä‘áº¿n N', explanation: 'Chá»‰ phÆ°Æ¡ng hÆ°á»›ng cá»§a hÃ nh Ä‘á»™ng di chuyá»ƒn. ã« vÃ  ã¸ cÃ³ thá»ƒ thay tháº¿ cho nhau.', example: 'æ—¥æœ¬ã¸è¡Œãã¾ã™ã€‚(TÃ´i Ä‘i Nháº­t.)' },
        { id: 'grammar_10', type: 'Ngá»¯ phÃ¡p', content: 'V-ã¾ã›ã‚“ã‹', meaning: 'CÃ¹ng lÃ m V khÃ´ng?', explanation: 'DÃ¹ng Ä‘á»ƒ má»i hoáº·c rá»§ rÃª ai Ä‘Ã³ cÃ¹ng lÃ m gÃ¬ má»™t cÃ¡ch lá»‹ch sá»±.', example: 'ä¸€ç·’ã«æ˜ ç”»ã‚’è¦‹ã¾ã›ã‚“ã‹ã€‚(CÃ¹ng Ä‘i xem phim khÃ´ng?)' },
    ],
    assessmentQuestions: [
        // Kanji
        { id: 'q_kanji_1', type: 'kanji', difficulty: -1.5, question: 'Chá»n cÃ¡ch Ä‘á»c cho ã€Œæ—¥ã€ trong ã€Œæ—¥æœ¬ã€', options: ['ã²', 'ã«', 'ã¤ã', 'ã‹'], answer: 'ã«' },
        { id: 'q_kanji_2', type: 'kanji', difficulty: -1.0, question: 'ã€Œç«ã€ cÃ³ nghÄ©a lÃ  gÃ¬?', options: ['NÆ°á»›c', 'Lá»­a', 'CÃ¢y', 'Äáº¥t'], answer: 'Lá»­a' },
        { id: 'q_kanji_3', type: 'kanji', difficulty: 0.0, question: 'ã€Œäººã€ Ä‘á»c lÃ  gÃ¬?', options: ['ã²ã¨', 'ã', 'ã‹ã­', 'ã¿ãš'], answer: 'ã²ã¨' },
        { id: 'q_kanji_4', type: 'kanji', difficulty: 0.5, question: 'ã€Œå¤§ãã„ã€ cÃ³ chá»¯ HÃ¡n lÃ  gÃ¬?', options: ['å¤§', 'å¤ª', 'çŠ¬', 'å¤©'], answer: 'å¤§' },
        // Vocab
        { id: 'q_vocab_1', type: 'vocab', difficulty: -0.5, question: 'Chá»n cÃ¡ch Ä‘á»c cho ã€Œå­¦ç”Ÿã€', options: ['ãŒãã›ã„', 'ãŒã£ã“ã†', 'ã›ã‚“ã›ã„', 'ã«ã»ã‚“'], answer: 'ãŒãã›ã„' },
        { id: 'q_vocab_2', type: 'vocab', difficulty: 0.5, question: 'ã€ŒUá»‘ngã€ trong tiáº¿ng Nháº­t lÃ  gÃ¬?', options: ['ãŸã¹ã¾ã™', 'ã®ã¿ã¾ã™', 'ã„ãã¾ã™', 'ã¾ãªã³ã¾ã™'], answer: 'ã®ã¿ã¾ã™' },
        { id: 'q_vocab_3', type: 'vocab', difficulty: 0.2, question: 'ã€ŒCÃ¡i nÃ yã€ trong tiáº¿ng Nháº­t lÃ  gÃ¬?', options: ['ã“ã‚Œ', 'ãã‚Œ', 'ã‚ã‚Œ', 'ã©ã‚Œ'], answer: 'ã“ã‚Œ' },
        { id: 'q_vocab_4', type: 'vocab', difficulty: -0.8, question: 'ã€Œã­ã“ã€ nghÄ©a lÃ  gÃ¬?', options: ['ChÃ³', 'CÃ¡', 'MÃ¨o', 'Chim'], answer: 'MÃ¨o' },
        { id: 'q_vocab_5', type: 'vocab', difficulty: 1.0, question: 'ã€ŒãŠã„ã—ã„ã€ nghÄ©a lÃ  gÃ¬?', options: ['Ngon', 'Dá»Ÿ', 'Äáº¯t', 'Ráº»'], answer: 'Ngon' },
        { id: 'q_vocab_6', type: 'vocab', difficulty: 1.2, question: 'ã€Œè²·ã†ã€ Ä‘á»c lÃ  gÃ¬?', options: ['ã‹ã†', 'ã†ã‚‹', 'ã®ã‚€', 'ã¿ã‚‹'], answer: 'ã‹ã†' },
        // Grammar
        { id: 'q_grammar_1', type: 'grammar', difficulty: 0.0, question: 'Äiá»n vÃ o chá»— trá»‘ng: ç”°ä¸­ã•ã‚“ã¯å…ˆç”Ÿã§ã™ã€‚å±±ç”°ã•ã‚“___å…ˆç”Ÿã§ã™ã€‚', options: ['ã¯', 'ãŒ', 'ã®', 'ã‚‚'], answer: 'ã‚‚' },
        { id: 'q_grammar_2', type: 'grammar', difficulty: 1.0, question: 'Dá»‹ch sang tiáº¿ng Nháº­t: "Äi Ä‘áº¿n trÆ°á»ng há»c."', options: ['å­¦æ ¡ã§é£Ÿã¹ã¾ã™', 'å­¦æ ¡ã«è¡Œãã¾ã™', 'å­¦æ ¡ã¯å…ˆç”Ÿã§ã™', 'å­¦æ ¡ã‚‚å¥½ãã§ã™'], answer: 'å­¦æ ¡ã«è¡Œãã¾ã™' },
        { id: 'q_grammar_3', type: 'grammar', difficulty: 2.0, question: 'Äiá»n vÃ o chá»— trá»‘ng: ç§___å­¦ç”Ÿã§ã™ã€‚', options: ['ã‚’', 'ãŒ', 'ã¯', 'ã‚‚'], answer: 'ã¯' },
        { id: 'q_grammar_4', type: 'grammar', difficulty: 0.8, question: 'Chá»n trá»£ tá»« Ä‘Ãºng: ç§ã¯ãƒã‚¹___å­¦æ ¡ã¸è¡Œãã¾ã™ã€‚', options: ['ã§', 'ã«', 'ã‚’', 'ã¨'], answer: 'ã§' },
        { id: 'q_grammar_5', type: 'grammar', difficulty: 1.5, question: 'ã€ŒCÃ¹ng Ä‘i xem phim khÃ´ng?ã€ lÃ  cÃ¢u nÃ o?', options: ['æ˜ ç”»ã‚’è¦‹ã¾ã™ã‹ã€‚', 'æ˜ ç”»ã‚’è¦‹ã¾ã›ã‚“ã‹ã€‚', 'æ˜ ç”»ã‚’è¦‹ãŸã„ã§ã™ã€‚', 'æ˜ ç”»ã‚’è¦‹ã¾ã—ãŸã€‚'], answer: 'æ˜ ç”»ã‚’è¦‹ã¾ã›ã‚“ã‹ã€‚' },
        { id: 'q_grammar_6', type: 'grammar', difficulty: 1.8, question: 'Chá»n dáº¡ng Ä‘Ãºng cá»§a tÃ­nh tá»«: ãã®ã†ã¯___ã§ã™ã€‚', options: ['ã‚ã¤ã„ã§ã™', 'ã‚ã¤ããªã„ã§ã™', 'ã‚ã¤ã‹ã£ãŸã§ã™', 'ã‚ã¤ããªã„ã§ã—ãŸ'], answer: 'ã‚ã¤ã‹ã£ãŸã§ã™' },
        // Reading
        { 
            id: 'q_reading_1', 
            type: 'reading', 
            difficulty: 1.5, 
            readingText: 'ç§ ã¯ ãƒžã‚¤ã‚¯ãƒ»ãƒŸãƒ©ãƒ¼ ã§ã™ã€‚IMC ã® ç¤¾å“¡ ã§ã™ã€‚ã‚µãƒ³ãƒˆã‚¹ã•ã‚“ ã‚‚ IMC ã® ç¤¾å“¡ ã§ã™ã€‚ã‚µãƒ³ãƒˆã‚¹ã•ã‚“ ã¯ ãƒ–ãƒ©ã‚¸ãƒ«äºº ã§ã™ã€‚',
            question: 'ã‚µãƒ³ãƒˆã‚¹ã•ã‚“ ã¯ ã©ã“ã® ç¤¾å“¡ ã§ã™ã‹ã€‚(Anh Santos lÃ  nhÃ¢n viÃªn cá»§a cÃ´ng ty nÃ o?)', 
            options: ['IMC', 'ãƒ–ãƒ©ã‚¸ãƒ«', 'ã‚ã‹ã‚Šã¾ã›ã‚“ (KhÃ´ng biáº¿t)', 'ãƒžã‚¤ã‚¯ãƒ»ãƒŸãƒ©ãƒ¼'], 
            answer: 'IMC' 
        },
        { 
            id: 'q_reading_2', 
            type: 'reading', 
            difficulty: 2.0, 
            readingText: 'ãã®ã†ã€ç§ã¯å‹é”ã¨äº¬éƒ½ã¸è¡Œãã¾ã—ãŸã€‚äº¬éƒ½ã¯ã¨ã¦ã‚‚ãã‚Œã„ã§ã—ãŸã€‚ãŸãã•ã‚“å†™çœŸã‚’æ’®ã‚Šã¾ã—ãŸã€‚',
            question: 'ãã®ã†ã€ä½•ã‚’ã—ã¾ã—ãŸã‹ã€‚(HÃ´m qua Ä‘Ã£ lÃ m gÃ¬?)', 
            options: ['äº¬éƒ½ã¸è¡Œãã¾ã—ãŸ', 'å†™çœŸã‚’æ’®ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'å‹é”ã¨ä¼šã„ã¾ã›ã‚“ã§ã—ãŸ', 'äº¬éƒ½ã¯ãã‚Œã„ã˜ã‚ƒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ'], 
            answer: 'äº¬éƒ½ã¸è¡Œãã¾ã—ãŸ' 
        },
        // Listening
        {
            id: 'q_listening_1',
            type: 'listening',
            difficulty: 1.0,
            question: 'Báº¡n nghe tháº¥y gÃ¬?',
            audioText: 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™',
            options: ['ã“ã‚“ã«ã¡ã¯', 'ã•ã‚ˆã†ãªã‚‰', 'ãŠã‚„ã™ã¿ãªã•ã„', 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™'],
            answer: 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™'
        },
        {
            id: 'q_listening_2',
            type: 'listening',
            difficulty: 1.2,
            question: 'Báº¡n nghe tháº¥y gÃ¬?',
            audioText: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™',
            options: ['ã™ã¿ã¾ã›ã‚“', 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™', 'ã”ã‚ã‚“ãªã•ã„', 'ã©ã†ãž'],
            answer: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™'
        },
        {
            id: 'q_listening_3',
            type: 'listening',
            difficulty: 1.8,
            question: 'Báº¡n nghe tháº¥y cÃ¢u há»i gÃ¬?',
            audioText: 'ãŠåå‰ã¯ä½•ã§ã™ã‹',
            options: ['ãŠå…ƒæ°—ã§ã™ã‹', 'ä½•æ­³ã§ã™ã‹', 'ãŠåå‰ã¯ä½•ã§ã™ã‹', 'ã”å‡ºèº«ã¯ã©ã¡ã‚‰ã§ã™ã‹'],
            answer: 'ãŠåå‰ã¯ä½•ã§ã™ã‹'
        },
         {
            id: 'q_listening_4',
            type: 'listening',
            difficulty: 2.0,
            question: 'Báº¡n nghe tháº¥y cÃ¢u tráº£ lá»i nÃ o cho "ã“ã‚Œã¯ä½•ã§ã™ã‹ã€‚"?',
            audioText: 'ãã‚Œã¯æ™‚è¨ˆã§ã™',
            options: ['ã¯ã„ã€ãã†ã§ã™', 'ã‚ã‚Œã¯æ¤…å­ã§ã™', 'ã„ã„ãˆã€é•ã„ã¾ã™', 'ãã‚Œã¯æ™‚è¨ˆã§ã™'],
            answer: 'ãã‚Œã¯æ™‚è¨ˆã§ã™'
        }
    ]
};

// --- Dá»® LIá»†U GIáº¢ Láº¬P CHO Báº N BÃˆ & Báº¢NG Xáº¾P Háº NG ---
const mockFriendsData = [
    { name: 'Minh Anh', xp: 18500, avatar: 'ðŸ‘©â€ðŸŽ“' },
    { name: 'Quá»‘c HÆ°ng', xp: 16200, avatar: 'ðŸ‘¨â€ðŸ’¼' },
    { name: 'Lan Chi', xp: 14800, avatar: 'ðŸ‘©â€ðŸ’»' },
];

// --- CÃC THÃ€NH PHáº¦N GIAO DIá»†N (ICONS) ---
const BookOpen = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>;
const Target = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>;
const Flame = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg>;
const Gem = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 3h12l4 6-10 13L2 9Z"></path><path d="M12 22V9"></path><path d="m3.29 9 8.71 13 8.71-13"></path><path d="M2 9h20"></path></svg>;
const Award = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="6"></circle><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"></path></svg>;
const Volume2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>;
const FileText = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>;
const ShoppingCart = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>;
const Sun = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>;
const Moon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>;
const Users = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;

// --- THÃ€NH PHáº¦N CHÃNH: App ---
export default function App() {
    const [view, setView] = useState('dashboard');
    const [userData, setUserData] = useState(null);
    const [userId, setUserId] = useState(null);
    const [loading, setLoading] = useState(true);
    const [theme, setTheme] = useState('light');
    const [showOnboarding, setShowOnboarding] = useState(false);

    useEffect(() => {
        const localTheme = localStorage.getItem('theme');
        if (localTheme) setTheme(localTheme);
    }, []);

    useEffect(() => {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
    }, [theme]);

    useEffect(() => {
        const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
            if (user) setUserId(user.uid);
            else signInAnonymously(auth).catch(error => console.error("Lá»—i Ä‘Äƒng nháº­p áº©n danh:", error));
        });
        return () => unsubscribeAuth();
    }, []);
    
    useEffect(() => {
        if (!userId) return;
        const userDocRef = doc(db, `artifacts/${appId}/users`, userId);
        const unsubscribeSnapshot = onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                setUserData(data);
                if (!data.hasCompletedOnboarding) setShowOnboarding(true);
            } else {
                const newUser = {
                    username: "TÃ¢n binh", total_xp: 0, koban: 100, streak: 0, current_level_focus: "n5",
                    progress: { n5: { xp: 0, lessons_completed: 0, kanji_learned: 0, vocab_learned: 0 } },
                    inventory: { streak_freezes: 0, themes: ['default'], avatars: ['default'] },
                    hasCompletedOnboarding: false
                };
  
