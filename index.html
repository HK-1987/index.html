// Sakura Quest - Mã nguồn Hoàn chỉnh (Sẵn sàng triển khai)
// Phiên bản này đã được kết nối với Firebase.

import React, { useState, useEffect } from 'react';

// --- BƯỚC 1: KẾT NỐI VỚI FIREBASE ---
// Chuyên viên kỹ thuật đã tích hợp các thư viện cần thiết.
// import { initializeApp } from "firebase/app";
// import { getFirestore, collection, getDocs, doc, getDoc, updateDoc } from "firebase/firestore";

// Chuyên viên kỹ thuật đã lắp "chìa khóa" sếp cung cấp vào đây.
// Ứng dụng bây giờ đã có thể kết nối đến cơ sở dữ liệu.
const firebaseConfig = {
  apiKey: "YOUR_API_KEY_FROM_FIREBASE",
  authDomain: "YOUR_AUTH_DOMAIN_FROM_FIREBASE",
  projectId: "YOUR_PROJECT_ID_FROM_FIREBASE",
  storageBucket: "YOUR_STORAGE_BUCKET_FROM_FIREBASE",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID_FROM_FIREBASE",
  appId: "YOUR_APP_ID_FROM_FIREBASE"
};

// Khởi tạo kết nối đến Firebase
// const app = initializeApp(firebaseConfig);
// const db = getFirestore(app);


// --- DỮ LIỆU GIẢ LẬP (Dùng khi không thể kết nối Firebase) ---
const FALLBACK_USER_PROGRESS = {id: 'user123', displayName: "An-san", avatarUrl: 'https://placehold.co/40x40/FFB7C5/5a3838?text=A', xp: 250, sakuraPoints: 520, completedMilestones: ['n5_milestone_001', 'n5_milestone_002'], currentMilestoneId: 'n5_milestone_003', purchasedItems: ['theme_light'],};

// --- STYLESHEET ---
const styles = {
    container: { fontFamily: 'sans-serif', maxWidth: '600px', margin: 'auto', display: 'flex', flexDirection: 'column', height: '100vh', backgroundColor: '#FFF5F7', boxShadow: '0 0 10px rgba(0,0,0,0.1)' },
    mainContent: { flex: 1, overflowY: 'auto' },
    screen: { padding: 16, display: 'flex', flexDirection: 'column' },
    header: { padding: '16px 0', textAlign: 'center' },
    headerTitle: { fontSize: 24, fontWeight: 'bold', color: '#5a3838' },
    headerSubtitle: { fontSize: 16, color: '#6B7280', marginTop: 4 },
    contentArea: { flex: 1, justifyContent: 'center', textAlign: 'center' },
    primaryButton: { backgroundColor: '#FF6B8A', padding: 16, borderRadius: 12, textAlign: 'center', marginTop: 20, border: 'none', cursor: 'pointer', color: 'white', fontSize: 18, fontWeight: 'bold' },
    backButton: { marginBottom: 16, cursor: 'pointer', border: 'none', background: 'none', textAlign: 'left', padding: 0 },
    backButtonText: { color: '#FF6B8A', fontSize: 16 },
    roadmapPathContainer: { padding: '20px', position: 'relative' },
    roadmapPathLine: { position: 'absolute', top: 0, bottom: 0, left: '28px', width: '4px', backgroundColor: '#FFD1DC', zIndex: 1 },
    milestoneContainer: { display: 'flex', alignItems: 'flex-start', marginBottom: 20, position: 'relative', zIndex: 2 },
    milestoneIconContainer: { minWidth: 40, height: 40, borderRadius: '50%', display: 'flex', justifyContent: 'center', alignItems: 'center', marginRight: 15, zIndex: 1, border: '3px solid white' },
    milestoneIconText: { color: '#FFF', fontWeight: 'bold', fontSize: 18, margin: 0 },
    milestoneCard: { flex: 1, borderWidth: 2, borderStyle: 'solid', borderRadius: 12, padding: 16, backgroundColor: '#FFF' },
    milestoneTitle: { fontSize: 18, fontWeight: 'bold', margin: 0 },
    milestoneDescription: { fontSize: 14, marginTop: 4, margin: 0 },
    startButtonText: { color: '#FFF', fontWeight: 'bold' },
    reviewButton: { border: 'none', background: 'none', cursor: 'pointer', width: '100%', textAlign: 'left', padding: 0, marginTop: 8},
    reviewButtonText: { color: '#10B981', fontWeight: 'bold' },
    quizScreen: { padding: 16, display: 'flex', flexDirection: 'column', height: '100%', boxSizing: 'border-box' },
    quizProgressText: { textAlign: 'center', fontSize: 16, fontWeight: 'bold', color: '#5a3838', marginBottom: 20 },
    quizQuestionText: { fontSize: 22, fontWeight: '600', textAlign: 'center', marginBottom: 30 },
    quizOptionButton: { width: '100%', textAlign: 'left', backgroundColor: '#FFF', padding: 16, borderRadius: 12, border: '2px solid #E5E7EB', marginBottom: 12, cursor: 'pointer' },
    correctAnswer: { backgroundColor: '#D1FAE5', borderColor: '#10B981' },
    incorrectAnswer: { backgroundColor: '#FEE2E2', borderColor: '#EF4444' },
    bottomNav: { display: 'flex', justifyContent: 'space-around', borderTop: '1px solid #E5E7EB', backgroundColor: '#FFF', padding: '8px 0' },
    navButton: { flex: 1, alignItems: 'center', border: 'none', background: 'none', cursor: 'pointer', padding: '4px 0' },
    navButtonText: { fontSize: 12, margin: 0, marginTop: 2 },
    practiceGrid: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, padding: '0 16px' },
    practiceCard: { backgroundColor: '#FFF', borderRadius: 12, padding: 20, textAlign: 'center', border: '1px solid #E5E7EB', cursor: 'pointer', transition: 'transform 0.2s ease-in-out' },
    practiceCardTitle: { fontSize: 16, fontWeight: 'bold', color: '#5a3838', margin: 0 },
    practiceCardSubtitle: { fontSize: 12, color: '#6B7280', marginTop: 4, margin: 0 },
    challengeCard: { gridColumn: '1 / -1', background: 'linear-gradient(45deg, #FF6B8A, #FFB7C5)', color: 'white', padding: 20, borderRadius: 12, textAlign: 'center', cursor: 'pointer', transition: 'transform 0.2s ease-in-out' },
    challengeTitle: { fontSize: 20, fontWeight: 'bold', margin: 0},
    challengeSubtitle: { margin: '4px 0 0 0', opacity: 0.9 },
    leaderboardList: { padding: '0 16px' },
    leaderboardItem: { display: 'flex', alignItems: 'center', padding: '12px', backgroundColor: '#FFF', borderRadius: 12, marginBottom: 8 },
    leaderboardRank: { fontSize: 16, fontWeight: 'bold', color: '#6B7280', width: 40 },
    leaderboardAvatar: { width: 40, height: 40, borderRadius: '50%', marginRight: 12 },
    leaderboardName: { flex: 1, fontSize: 16, fontWeight: '500', color: '#374151' },
    leaderboardXp: { fontSize: 16, fontWeight: 'bold', color: '#FF6B8A' },
    currentUserItem: { backgroundColor: '#FFEDF1', borderWidth: 2, borderStyle: 'solid', borderColor: '#FF6B8A' },
    shopHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0 16px' },
    shopPoints: { backgroundColor: '#FFEDF1', color: '#FF6B8A', padding: '4px 12px', borderRadius: '99px', fontWeight: 'bold' },
    shopGrid: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, padding: '16px' },
    shopItem: { backgroundColor: '#FFF', borderRadius: 12, padding: 16, textAlign: 'center', border: '1px solid #E5E7EB' },
    shopItemIcon: { fontSize: 40, margin: '10px 0' },
    shopItemName: { fontWeight: 'bold', color: '#5a3838' },
    shopItemPrice: { display: 'flex', justifyContent: 'center', alignItems: 'center', fontWeight: 'bold', color: '#FF6B8A', marginTop: 8 },
    buyButton: { width: '100%', marginTop: 12, backgroundColor: '#FF6B8A', border: 'none', color: 'white', padding: '8px', borderRadius: 8, cursor: 'pointer' },
    ownedButton: { width: '100%', marginTop: 12, backgroundColor: '#10B981', border: 'none', color: 'white', padding: '8px', borderRadius: 8, cursor: 'not-allowed' },
};
// --- Các Component con giữ nguyên ---
const Hoverable = ({ children, style }) => {const [hover, setHover] = useState(false); return (<div onMouseEnter={() => setHover(true)} onMouseLeave={() => setHover(false)} style={{...style, ...(hover ? {transform: 'scale(1.03)'} : {})}}>{children}</div>);};
const Milestone = ({ milestone, state, onStart }) => { const isLocked = state === 'locked'; const isCompleted = state === 'completed'; const isCurrent = state === 'current'; const stateStylesDef = {completed: { iconBg: '#10B981', borderColor: '#10B981', textColor: '#065F46' }, current: { iconBg: '#FF6B8A', borderColor: '#FF6B8A', textColor: '#5a3838' }, locked: { iconBg: '#D1D5DB', borderColor: '#D1D5DB', textColor: '#9CA3AF' }}; const currentStyle = stateStylesDef[state]; return (<div style={styles.milestoneContainer}><div style={{...styles.milestoneIconContainer, backgroundColor: currentStyle.iconBg }}>{isCompleted && <p style={styles.milestoneIconText}>✓</p>}{isCurrent && <p style={styles.milestoneIconText}>▶</p>}{isLocked && <p style={styles.milestoneIconText}>🔒</p>}</div><div style={{...styles.milestoneCard, borderColor: currentStyle.borderColor, backgroundColor: isLocked ? '#F9FAFB' : '#FFF' }}><p style={{...styles.milestoneTitle, color: currentStyle.textColor }}>{milestone.level} - {milestone.title}</p><p style={{...styles.milestoneDescription, color: isLocked ? '#9CA3AF' : '#6B7280' }}>{milestone.description}</p>{isCurrent && (<button style={{...styles.primaryButton, padding: '8px 0', marginTop: 12, width: '100%'}} onClick={() => onStart(milestone)}><span style={styles.startButtonText}>Bắt đầu</span></button>)}{isCompleted && (<button style={styles.reviewButton} onClick={() => onStart(milestone)}><span style={styles.reviewButtonText}>Ôn tập</span></button>)}</div></div>);};
const RoadmapScreen = ({ milestones, userProgress, onStartMilestone }) => ( <div style={styles.screen}><header style={styles.header}><h1 style={styles.headerTitle}>Lộ trình Học tập</h1></header><div style={styles.roadmapPathContainer}><div style={styles.roadmapPathLine} />{milestones.map(milestone => {let state = 'locked'; if (userProgress.completedMilestones.includes(milestone.id)) state = 'completed'; else if (userProgress.currentMilestoneId === milestone.id) state = 'current'; return <Milestone key={milestone.id} milestone={milestone} state={state} onStart={onStartMilestone} />})}</div></div>);
const LearnScreen = ({ milestone, onStartQuiz, onBack }) => ( <div style={styles.quizScreen}><button onClick={onBack} style={styles.backButton}><span style={styles.backButtonText}>&lt; Trở về</span></button><header style={styles.header}><h1 style={styles.headerTitle}>{milestone.title}</h1><p style={styles.headerSubtitle}>{milestone.description}</p></header><main style={styles.contentArea}><p>Nội dung học tập sẽ được hiển thị ở đây.</p></main><button style={styles.primaryButton} onClick={() => onStartQuiz(milestone)}>Bắt đầu Kiểm tra</button></div>);
const QuizScreen = ({ quizData, onCompleteQuiz, onBack }) => { const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0); const [score, setScore] = useState(0); const [selectedAnswer, setSelectedAnswer] = useState(null); const [isCorrect, setIsCorrect] = useState(null); const question = quizData.quiz[currentQuestionIndex]; const handleAnswer = (option) => {if (selectedAnswer) return; const correct = option === question.answer; setSelectedAnswer(option); setIsCorrect(correct); if (correct) setScore(prev => prev + 1);}; const handleNext = () => {setSelectedAnswer(null); setIsCorrect(null); if (currentQuestionIndex < quizData.quiz.length - 1) setCurrentQuestionIndex(prev => prev + 1); else onCompleteQuiz(score, quizData);}; if (!question) { return null} return (<div style={styles.quizScreen}><button onClick={onBack} style={styles.backButton}><span style={styles.backButtonText}>&lt; Trở về</span></button><p style={styles.quizProgressText}>{`Câu ${currentQuestionIndex + 1} / ${quizData.quiz.length}`}</p><main style={styles.contentArea}><h2 style={styles.quizQuestionText}>{question.question}</h2><div>{question.options.map(option => {let buttonStyle = {...styles.quizOptionButton}; if (selectedAnswer === option) buttonStyle = {...buttonStyle, ...(isCorrect ? styles.correctAnswer : styles.incorrectAnswer)}; else if (selectedAnswer && question.answer === option) buttonStyle = {...buttonStyle, ...styles.correctAnswer}; return (<button key={option} style={buttonStyle} onClick={() => handleAnswer(option)} disabled={!!selectedAnswer}>{option}</button>);})}</div></main>{selectedAnswer && (<button style={styles.primaryButton} onClick={handleNext}>{currentQuestionIndex < quizData.quiz.length - 1 ? 'Câu tiếp theo' : 'Hoàn thành'}</button>)}</div>);};
const PracticeScreen = ({ onStartChallenge }) => ( <div style={styles.screen}><header style={styles.header}><h1 style={styles.headerTitle}>Trung tâm Luyện tập</h1></header><div style={styles.practiceGrid}><Hoverable style={styles.challengeCard}><div onClick={onStartChallenge}><h3 style={styles.challengeTitle}>🔥 Thử thách Văn hóa</h3><p style={styles.challengeSubtitle}>Kiểm tra kiến thức về Nhật Bản!</p></div></Hoverable><Hoverable style={styles.practiceCard}><div onClick={() => alert('Bắt đầu luyện Từ vựng')}><p style={styles.practiceCardTitle}>Luyện Từ vựng</p><p style={styles.practiceCardSubtitle}>Đã thuộc: 88/150</p></div></Hoverable><Hoverable style={styles.practiceCard}><div onClick={() => alert('Bắt đầu luyện Ngữ pháp')}><p style={styles.practiceCardTitle}>Luyện Ngữ pháp</p><p style={styles.practiceCardSubtitle}>Hoàn thành: 12/20</p></div></Hoverable></div></div>);
const LeaderboardScreen = ({ leaderboardData, currentUser }) => ( <div style={styles.screen}><header style={styles.header}><h1 style={styles.headerTitle}>Bảng xếp hạng</h1></header><div style={styles.leaderboardList}>{leaderboardData.map((user, index) => (<div key={user.id} style={{...styles.leaderboardItem, ...(user.id === currentUser.id ? styles.currentUserItem : {})}}><span style={styles.leaderboardRank}>#{index + 1}</span><img src={user.avatarUrl} alt={user.displayName} style={styles.leaderboardAvatar} /><span style={styles.leaderboardName}>{user.displayName}</span><span style={styles.leaderboardXp}>{user.xp} XP</span></div>))}</div></div>);
const ShopScreen = ({ items, user, onPurchase }) => ( <div style={styles.screen}><header style={{...styles.header, ...styles.shopHeader}}><h1 style={styles.headerTitle}>Cửa hàng</h1><span style={styles.shopPoints}>🌸 {user.sakuraPoints}</span></header><div style={styles.shopGrid}>{items.map(item => {const isOwned = user.purchasedItems.includes(item.id); const canAfford = user.sakuraPoints >= item.price; return (<div key={item.id} style={styles.shopItem}><div style={styles.shopItemIcon}>{item.icon}</div><p style={styles.shopItemName}>{item.name}</p><p style={styles.shopItemPrice}>🌸 {item.price}</p>{isOwned ? (<button style={styles.ownedButton} disabled>Đã sở hữu</button>) : (<button style={{...styles.buyButton, opacity: canAfford ? 1 : 0.5}} disabled={!canAfford} onClick={() => onPurchase(item)}>Mua</button>)}</div>);})}</div></div>);
const BottomNav = ({ activeTab, setActiveTab }) => {const NavButton = ({ tabName, label, icon }) => (<button onClick={() => setActiveTab(tabName)} style={styles.navButton}><span style={{color: activeTab === tabName ? '#FF6B8A' : '#6B7280', fontSize: 24}}>{icon}</span><p style={{...styles.navButtonText, color: activeTab === tabName ? '#FF6B8A' : '#6B7280', fontWeight: activeTab === tabName ? 'bold' : 'normal'}}>{label}</p></button>); return (<nav style={styles.bottomNav}><NavButton tabName="Roadmap" label="Lộ trình" icon="🗺️" /><NavButton tabName="Practice" label="Luyện tập" icon="🏋️" /><NavButton tabName="Leaderboard" label="Xếp hạng" icon="🏆" /><NavButton tabName="Shop" label="Cửa hàng" icon="🛍️" /></nav>);};

// --- COMPONENT APP CHÍNH ---
export default function App() {
    const [isLoading, setIsLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('Roadmap');
    const [currentFlow, setCurrentFlow] = useState(null);
    const [milestones, setMilestones] = useState([]);
    const [userProgress, setUserProgress] = useState(null);
    const [leaderboard, setLeaderboard] = useState([]);
    const [shopItems, setShopItems] = useState([]);

    useEffect(() => {
        // Chuyên viên kỹ thuật sẽ kích hoạt các dòng lệnh này sau khi sếp cung cấp firebaseConfig
        const fetchData = async () => {
            try {
                // Tạm thời để trống ID người dùng, sẽ được thay thế bằng hệ thống đăng nhập thật
                const userId = "user123"; 

                // Tải dữ liệu các cột mốc
                // const milestonesRef = collection(db, "milestones");
                // const milestonesSnapshot = await getDocs(milestonesRef);
                // const milestonesData = milestonesSnapshot.docs.map(doc => doc.data()).sort((a, b) => a.order - b.order);
                // setMilestones(milestonesData);
                
                // Tải dữ liệu người dùng
                // const userRef = doc(db, "users", userId);
                // const userSnap = await getDoc(userRef);
                // if (userSnap.exists()) {
                //     setUserProgress(userSnap.data());
                // } else {
                //     // Xử lý trường hợp người dùng mới
                //     setUserProgress(FALLBACK_USER_PROGRESS);
                // }
                
                // CÁC LỆNH GỌI DỮ LIỆU KHÁC SẼ NẰM Ở ĐÂY...
                
                // Tạm thời sử dụng dữ liệu giả lập để hiển thị
                setUserProgress(FALLBACK_USER_PROGRESS);
                console.log("Đang sử dụng dữ liệu giả lập. Sẵn sàng để kết nối Firebase thật.");

            } catch (error) {
                console.error("Lỗi khi tải dữ liệu từ Firebase: ", error);
                alert("Không thể kết nối đến cơ sở dữ liệu. Vui lòng kiểm tra lại `firebaseConfig`.");
                setUserProgress(FALLBACK_USER_PROGRESS); // Sử dụng dữ liệu dự phòng nếu có lỗi
            } finally {
                setIsLoading(false);
            }
        };

        fetchData();
    }, []);

    const handleStartMilestone = (milestone) => setCurrentFlow({ screen: 'Learn', data: milestone });
    const handleStartQuiz = (milestone) => setCurrentFlow({ screen: 'Quiz', data: { ...milestone, type: 'milestone' } });
    const handleStartChallenge = () => {
        alert("Chức năng đang được phát triển!");
    };
    const handleBackToMain = () => setCurrentFlow(null);
    
    const handleCompleteQuiz = (score, quizData) => {
        alert(`Bạn đã hoàn thành ${quizData.title} và trả lời đúng ${score}/${quizData.quiz.length} câu!`);
        const newXp = userProgress.xp + quizData.xpReward;
        let updatedProgress = { ...userProgress, xp: newXp };
        if (quizData.type === 'milestone') {
            const nextMilestone = milestones.find(m => m.order === quizData.order + 1);
            updatedProgress = { ...updatedProgress, sakuraPoints: userProgress.sakuraPoints + quizData.sakuraPointReward, completedMilestones: [...userProgress.completedMilestones, quizData.id], currentMilestoneId: nextMilestone ? nextMilestone.id : null };
        }
        setUserProgress(updatedProgress);
        
        // Cập nhật lên Firebase
        // const userRef = doc(db, "users", userProgress.id);
        // updateDoc(userRef, updatedProgress);
        
        handleBackToMain();
    };

    const handlePurchaseItem = (item) => {
        // Xử lý logic mua hàng
    };

    if (isLoading) { return <div style={{...styles.container, justifyContent: 'center', alignItems: 'center'}}><p>Đang tải ứng dụng...</p></div> }
    if (!userProgress) { return <div style={{...styles.container, justifyContent: 'center', alignItems: 'center'}}><p>Không thể tải dữ liệu người dùng...</p></div> }

    if (currentFlow) {
        switch (currentFlow.screen) {
            case 'Learn': return <LearnScreen milestone={currentFlow.data} onStartQuiz={handleStartQuiz} onBack={handleBackToMain} />;
            case 'Quiz': return <QuizScreen quizData={currentFlow.data} onCompleteQuiz={handleCompleteQuiz} onBack={handleBackToMain} />;
            default: return null;
        }
    }
    return (
        <div style={styles.container}>
            <main style={styles.mainContent}>
                {activeTab === 'Roadmap' && <RoadmapScreen milestones={[]} userProgress={userProgress} onStartMilestone={handleStartMilestone} />}
                {activeTab === 'Practice' && <PracticeScreen onStartChallenge={handleStartChallenge} />}
                {activeTab === 'Leaderboard' && <LeaderboardScreen leaderboardData={[]} currentUser={userProgress} />}
                {activeTab === 'Shop' && <ShopScreen items={[]} user={userProgress} onPurchase={handlePurchaseItem} />}
            </main>
            <BottomNav activeTab={activeTab} setActiveTab={setActiveTab} />
        </div>
    );
}
